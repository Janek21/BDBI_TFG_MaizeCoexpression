---
title: "Gene Network"
author: "Jan Izquierdo i Ramos"
date: "2025-02-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(purl = TRUE)
```

# Loading

## Load libraries

```{r loadLib}
library(WGCNA)
allowWGCNAThreads()
library(randomcoloR)
library(edgeR)
library(tidyverse)
library(dplyr)
library(grid)
library(gridExtra)
#devtools::install_github("kevinblighe/CorLevelPlot")
library(CorLevelPlot)
library(ggpubr)
```

## Load the data

Import the csv and metadata files

```{r dtLoad}
#"B73"   "DK105" "EP1"   "F7"    "PE75" 
specie<-""
dataPath<-paste0("../data/wlen/data_wlen", specie, ".csv")
metadataPath<-paste0("../data/metadata", specie, ".txt")

dataNL<-read.delim(dataPath, row.names=1, stringsAsFactors=TRUE)
metadata<-read.delim(metadataPath, header=T, row.names=1, stringsAsFactors=TRUE)
#dataNL<-read.delim("../data/data_nolen.csv", row.names=1, stringsAsFactors=TRUE)
#metadata<-read.delim("../data/metadata.txt", header=T, row.names=1, stringsAsFactors=TRUE)

colnames(metadata)<-c("specie", "quality", "tissue_abv", "rep", "location")
```

# Data preparation

## Get lengths vector

```{r getLen}
if ("Length" %in% colnames(dataNL)){
  length_vec<-dataNL$Length
}
```



## Fix the data

Search for dimensional disparities

```{r dataSearch}
dim(dataNL)
dim(metadata)
```

### Match metadata rows to data columns

Just in case lets match the samples

```{r dataMatch}
dataMatcher<-function(data, metadata){
  options(warn=-1)
  
  cat("Data begins with:" , dim(data))
  cat("\nMetadata begins with:", dim(metadata))
  #Match data to metadata
  data <- data[, order(colnames(data))]
  metadata <- metadata[order(rownames(metadata)), ]
  
  cat("\nColumns data = Rows of metatdata?", all(rownames(metadata) == colnames(data)))
  #If TRUE, columns of data and rows of metadata are matched
  
  cat("\nRemove the excess from data")
  data<-data[,colnames(data) %in% rownames(metadata)] #remove data not present in metadata
  cat("\nData end with:" , dim(data))
  
  cat("\nRemove the excess from metadata")
  metadata<-metadata[rownames(metadata) %in% colnames(data),] #remove metadata not present in data
  cat("\nMetadata end with:" , dim(metadata), "\n")
  
  options(warn=0)
  return(list(data, metadata))
}

jointData<-dataMatcher(dataNL, metadata)

dataNL<-jointData[[1]]
metadata<-jointData[[2]]
```

### Metadata levels

```{r metadtaCheck}
#Should be all 0 due to preprocessing filtering
levels(as.factor(metadata$quality))

#Mapped abreviations
levels(metadata$tissue_abv)

#reps 1,2,3 and 4, is there an imbalance?
table(metadata$rep)

levels(metadata$location)
#Different rep aoumts indicate different amount of each replicate
table(metadata$location) 
#there are different total numbers of tissue replicates
#Solve it by using 1 replicate per tissue (mean of exisitng replicates)

```
### Outlier check

Check for outlier genes

```{r OutlierGenes}
outDetect<-goodSamplesGenes(t(dataNL))

table(outDetect$goodGenes) #False genes are outliers
table(outDetect$goodSamples) #All samples are True = no outliers
```

```{r OutlierGeRemove}
dataNL<-dataNL[outDetect$goodGenes==TRUE,] #remove ouliers

if (exists("length_vec")){ #only if it exists
  length_vec<-length_vec[outDetect$goodGenes==TRUE] #if length_vec exists remove outliers from there as well
}

```

## Replicate joining

```{r replSpecieName}
#add the name of the species to the replicate, to be able to differentiate it

#save location
metadata$org_location<-as.factor(metadata$location)
#create specialized location
metadata$location<-paste(metadata$specie, metadata$location, sep="_")
metadata$location<-as.factor(metadata$location)

```

```{r replJoin}
rsumer<-function(data, metadata, tissue_name){ #calculates the mean of all columns that belong to a location (mean of all COB columns)
  
  loc_mdata<-metadata[metadata$location == tissue_name, ] #filter metadata tissue (get metadata of location only)
  
  data<-data[,colnames(data) %in% rownames(loc_mdata)] #get data of lcoation only, based on metadata
  
  if (1<ncol(data.frame(data))){ #If theres only 1 replicate, dont try to do the mean (it gives error)
    data<-rowMeans(data) #calculate mean for each gene out of the locations(replicates)
  }
  
  return(as.data.frame(data))
}

tissue_data<-levels(metadata$location) #get list of tissue names

d_joint<-sapply(tissue_data, function(tissue_name) rsumer(dataNL, metadata, tissue_name)) #returns an array where each entry is a column with the mean data of the replicates (rows are genes)

repl_data<-as.data.frame(d_joint) #data joint by replicate

colnames(repl_data) = gsub(pattern = "*.data", replacement = "", x = tolower(colnames(repl_data))) #get column names to be only location

rownames(repl_data)<-rownames(dataNL) #rename rows to be genes again

```

Create replicate metadata
```{r replMeta}
repl_meta<-as.data.frame(colnames(repl_data))
colnames(repl_meta)<-c("location")

temp_meta<-data.frame(t(data.frame(strsplit(as.character(repl_meta$location), "_"))))
repl_meta<-data.frame(repl_meta$location, temp_meta$X1, temp_meta$X2)
colnames(repl_meta)<-c("location", "species", "org_location")
```

# Data diagnostic

## Plot the raw data

Create the plot functions and plot information
```{r rawPlotPrep}
multiColHist<-function(data, location, color_var){ #gets the data table, the concrete column(tissue) and the color for the tissue
  loc_var<-data[[location]] #get the tissue data
  p<-ggplot(data, aes(x=loc_var))+
    geom_histogram(bins = 30, fill=color_var, color="black")+
    xlab("")+ylab("")+theme_minimal() #plot a colored histogram for all genes of X tissue
  return(p)
}

nn<-seq(1,149, by=15)

colorList<-distinctColorPalette(length(nn)) #make a list with a color for each tissue

#Create a legend that realates each color to a tissue

#use the repl_meta dataframe for creating the plot, as it contains all tissue(location) names
legend_plot<-ggplot(repl_meta[nn,], aes(x=1, y=location, color=location))+
  geom_point()+
  scale_color_manual(values=colorList)+
  guides(color=guide_legend(ncol=1))+
  theme_void()+labs(color="Tissue")+
  theme(legend.title=element_text(size=18),
        legend.text=element_text(size=15)) #plot used only to get the legend that associates colors with localizations(tissues)

legend_var<-get_legend(legend_plot) #place the legend into a variable
```

Create the plot list
```{r rawPlotListing}
RawHistList<-list() #to store the plots

for (i in 1:nrow(repl_meta[nn,])){
  color_var<-colorList[i]
  loc<-colnames(repl_data)[i]
  
  temp_plot<-multiColHist(repl_data, loc, color_var)
  RawHistList[[i]]<-temp_plot
} #iterates over each tissue, creates a plot with a distinct color for it and stores it in a list
```

Joins the plot and legend to create a plot of the total raw data distribution
```{r rawPlot}
plotTitle<-paste0(specie, " raw data distribution")

raw_Ptab<-arrangeGrob(grobs=RawHistList, ncol=ceiling(nrow(repl_meta[nn,])/6)) #creates a table that organizes the plots

#png(paste0("./DistrPlots/", specie, "_raw_distPlot.png"), width=1600, height=800) #B73_CPM_raw_distPlot
grid.arrange(raw_Ptab, legend_var, widths = c(10, 2.3), ncol=2, top=textGrob(plotTitle, gp=gpar(fontsize=20))) #plots the plot list and legend together
#dev.off()
```

## Normalization

We can't use VST methods as we have 1 replicate of each type, it would be unreliable, we will use cpm and rpkm

### CPM

```{r CPMnorm}
#@@ remove lowly expressed genes
#uses edgeR
dge <- DGEList(repl_data)

#Calculate normalization factors
dge <- calcNormFactors(dge)

#Get normalized counts
Nrepl_data <- cpm(dge, log=TRUE) #rpkm with lengths, testo other normalizations too

NormType<-"CPM"
```

#### Low expression removal

```{r CPMlExpRm}
#Filter low expression genes
#keep<-rowSums(Nrepl_data>1)>=12 #as most lowly expressed genes are slightly above 0(=1), so we filter starting at 1 rep and more than 10 total in samples
keep<-rowSums(Nrepl_data>=0)>=0 #@@ only >=0 erases bell curve
keep<-apply(Nrepl_data, 1, max)>=0
Nrepl_data<-Nrepl_data[keep,]

#Nrepl to data frame
Nrepl_data<-as.data.frame(Nrepl_data) #evetually transpose

#@@ Less genes kept for similar normality plots in rpkm (b73 tested)
```

#### Plot CPM normalized data

Create a function to plot the data
```{r normPLotFunc}
#@@ analyze CPM and RPKN and choose 1
multiColLine<-function(data, location, color_var){ #gets the data table, the concrete column(tissue) and the color for the tissue
  loc_var<-data[[location]] #get the tissue data
  p<-ggplot(data, aes(x=loc_var))+geom_density(fill=color_var, color="black")+
    xlab("")+ylab("")+theme_minimal() #plot a colored line graph for all genes of X tissue
  return(p)
}
```

Create the plot list
```{r CPMnormPlotListing}
NormHistList<-list() #to store the plots

for (i in 1:nrow(repl_meta[nn,])){
  color_var<-colorList[i]
  loc<-colnames(repl_data)[i]
  
  temp_plot<-multiColHist(Nrepl_data, loc, color_var)
  NormHistList[[i]]<-temp_plot
} #iterates over each tissue, creates a plot with a distinct color for it and stores it in a list
```

Joins the plot and legend to create a plot of the total normalized data distribution
```{r CPMnormPlot}
plotTitle<-paste0(specie, " normalized data distribution using ", NormType)

norm_Ptab<-arrangeGrob(grobs=NormHistList, ncol=ceiling(nrow(repl_meta[nn,])/6)) #creates a table that organizes the plots

#png(paste0("./DistrPlots/", specie, "_norm", NormType, "_distPlot.png"), width=1600, height=800) #B73_normCPM_distPlot
grid.arrange(norm_Ptab, legend_var, widths = c(10, 2.3), ncol=2, top=textGrob(plotTitle, gp=gpar(fontsize=20))) #plots the plot list and legend together
#dev.off()
```


### RPKM

Only if we have the gene lengths
```{r RPKMnorm}
if (exists("length_vec")){ #if we have lengths
 length_vec<-data.frame(Length=length_vec) #convert to dataframe

  dge <- DGEList(repl_data,genes=length_vec) #use edgeR for normalization

  dge <- calcNormFactors(dge)

  Nrepl_data <- rpkm(dge, log=TRUE)

  Nrepl_data<-as.data.frame(Nrepl_data)
  
  NormType<-"RPKM"
}
```

#### Low expression removal

```{r RPKMlExpRm}
#Filter low expression genes
keep<-rowSums(Nrepl_data>=0)>=0 #as most lowly expressed genes are slightly above 0(=1), so we filter starting at 1 rep and more than 5 total in samples
keep<-apply(Nrepl_data, 1, max)>=0
Nrepl_data<-Nrepl_data[keep,]

#@@ Difference between 12 and 6 is important? -> it is we only do rpkm

#Nrepl to data frame
Nrepl_data<-as.data.frame(Nrepl_data) #evetually transpose

#@@ More genes kept for similar normality plots than cpm (b73 tested)
```


#### Plot RPKM normalized data

Create the plot list
```{r RPKMnormPlotListing}
## Plotting the normalized data counts <-allPLot Title
NormHistList<-list() #to store the plots

for (i in 1:nrow(repl_meta[nn,])){
  color_var<-colorList[i]
  loc<-colnames(repl_data)[i]
  
  temp_plot<-multiColHist(Nrepl_data, loc, color_var)
  NormHistList[[i]]<-temp_plot
} #iterates over each tissue, creates a plot with a distinct color for it and stores it in a list
```

Joins the plot and legend to create a plot of the total normalized data distribution
```{r RPKMnormPlot}
plotTitle<-paste0(specie, " normalized data distribution using ", NormType)

norm_Ptab<-arrangeGrob(grobs=NormHistList, ncol=ceiling(nrow(repl_meta[nn,])/6)) #creates a table that organizes the plots

#png(paste0("./DistrPlots/", specie, "_norm", NormType, "_distPlot.png"), width=1600, height=800) #B73_normCPM_distPlot
grid.arrange(norm_Ptab, legend_var, widths = c(10, 2.3), ncol=2,  top=textGrob(plotTitle, gp=gpar(fontsize=20))) #plots the plot list and legend together
#dev.off()
```

# Umap

## Raw UMAP
```{r funcDef}
library(umap)

dataPlotter<-function(umap_data, metadata){
  plt<-ggplot(as.data.frame(umap_data$layout), aes(x=umap_data$layout[,1], y=umap_data$layout[,2], shape=metadata$species, color=metadata$org_location))+
    geom_point(size=6)+
    scale_shape_manual(values = c(19, 1, 2, 15, 8))+
    labs(x="x", y="y", shape="Species", color="Tissue")+
    theme_minimal()
  return(plt)
}
```


```{r rawUMAP}
repl_UMAP<-as.data.frame(t(repl_data))

raw_umap_data<-umap(repl_UMAP)

plotly::ggplotly(dataPlotter(raw_umap_data, repl_meta)+ggtitle("Raw data Umap"))
```

##Normalized Umap
```{r nUMAP}
#Nrepl_data<-sweep(repl_data, 1, rowSums(repl_data), "/") #converts sample counts into relative frequencies for genes
Nrepl_UMAP<-as.data.frame(t(Nrepl_data))

Numap_data<-umap(Nrepl_UMAP)

dataPlotter(Numap_data, repl_meta)+ggtitle("Normalized data Umap")
```

```{r sc_nUMAP}
sc_Nrepl_UMAP<-scale(Nrepl_UMAP)

sc_Numap_data<-umap(sc_Nrepl_UMAP)

plotly::ggplotly(dataPlotter(sc_Numap_data, repl_meta)+ggtitle("Scaled data Umap"))
```

```{r scUMAP_alt}
umap_data<-sc_Numap_data

plotly::ggplotly(ggplot(as.data.frame(umap_data$layout), aes(x=umap_data$layout[,1], y=umap_data$layout[,2], color=repl_meta$org_location))+
  geom_point(size=5)+
  scale_shape_manual(values = c(19, 1, 2, 15, 8))+
  #scale_color_manual(colorList)+
  theme_minimal()+ggtitle("Tissue-based"))

ggplot(as.data.frame(umap_data$layout), aes(x=umap_data$layout[,1], y=umap_data$layout[,2], color=repl_meta$species))+
  geom_point(size=5)+
  scale_shape_manual(values = c(19, 1, 2, 15, 8))+
  theme_minimal()+ggtitle("Species-based")

```
```{r}
FinalUmap<-umap(sc_Nrepl_UMAP, n_neighbors=35, n_epochs=450, min_dist=0.1) #nneighbor: 22, [29] ##rework depending on normalization
#Modify min_dist as 0.1 fits better the data in this case

plotly::ggplotly(dataPlotter(FinalUmap, repl_meta)+
  ggtitle("Final UMAP with cleaned data"))
```


# Heatmap

```{r heatmapPrep}
# Install package if needed
library(pheatmap)

# Convert dataframe to matrix (genes as rows, samples as columns)
expression_matrix <- as.matrix(Nrepl_data)

sample_correlations <- cor(expression_matrix)
```

```{r heatmapColSort}
#@@ USELESS
extract_parts <- function(name) {
  strsplit(name, "_")[[1]]  # Get the part after the underscore
}

parted_names<-as.data.frame(t(data.frame(sapply(colnames(sample_correlations), extract_parts))))

NameList<-paste0(parted_names$V2,"_", parted_names$V1)

colnames(sample_correlations)<-NameList
rownames(sample_correlations)<-NameList


sample_correlations <- sample_correlations[, sort(colnames(sample_correlations))]
sample_correlations <- sample_correlations[order(rownames(sample_correlations)), ]
```

```{r heatmap}

pheatmap(sample_correlations,
                   clustering_method = "complete")

library(heatmaply)

heatmaply(sample_correlations, clustering_method = "complete",
          colors = viridis(n = 256, option = "inferno", direction=-1))

heatmaply(sample_correlations, clustering_method = "complete",
          colors = blueWhiteRed(256),
          #grid_color = "black",
          grid_gap = 0.001)

```













































# Network construction


## Power choosing

Get list of powers and do the calculations
```{r nwPowerList}
Nrepl_data<-t(Nrepl_data)

power <- c(c(1:15), seq(from = 17, to = 50, by = 2))
#power<-c(1:40)

#Network topology analysis
sft <- pickSoftThreshold(Nrepl_data,
                  powerVector = power,
                  networkType = "signed",
                  verbose = 5)

```

Plot and choose the best possible outcome
```{r nwPowerPLot, purl=FALSE}
sftIn<-sft$fitIndices

p1<-ggplot(sftIn, aes(Power, SFT.R.sq, label = Power)) +
  geom_point() +
  geom_text(nudge_y = 0.1) +
  geom_hline(yintercept = 0.8, color = 'red') +
  labs(x = 'Power', y = 'Scale free topology model fit\nsigned R^2') +
  theme_classic()

p2<-ggplot(sftIn, aes(Power, mean.k., label = Power)) +
  geom_point() +
  geom_text(nudge_y = 1500) +
  labs(x = 'Power', y = 'Mean Connectivity') +
  theme_classic()

grid.arrange(p1, p2, nrow=2)
```

```{r nwPowerChoose}
print(sft$powerEstimate)
#Use automatic calculation
if (is.na(sft$powerEstimate)){
  softPw<-30 #if the soft power is NA, set to 30, else take smallest possible
}else{
  softPw <- min(sft$powerEstimate, 30)
  }

if (specie=="DK105"){
  softPw<-24 #4000
  #softPw<-26 #6000
  #softPw<-30 #8000
}

```

## Block building

```{r nwConstr}
temp_cor <- cor
cor <- WGCNA::cor

ModNetwork <- blockwiseModules(Nrepl_data,
                 nThreads = 32, #16
                 maxBlockSize = 64000, #directly related to memory, if maxBlockSize<total genes, multiple blocks will have to be used -> worse clustering
                 deepSplit = 4,
                 TOMType = "unsigned", #unsigned?
                 power = softPw,
                 mergeCutHeight = 0.3,#0.3->4799#0.8->4799(low module granularity) #0.1->4799(high granularity(lots of colors))
                 minModuleSize = 20,
                 numericLabels = FALSE,
                 pamRespectsDendro = FALSE,
                 minKMEtoStay = 0.3,#0.3->4799 #0.8->7781 #<0.3 stays the same
                 randomSeed = 42,
                 verbose = 4)


cor<-temp_cor
```

# Modules and eigengenes

Eigengenes summarize gene expression for a module(cluster of highly co-expressed genes(detected by similar gene expression patterns)) using PC1.
Group up genes into 1 value
```{r EigenColors}
#@@remove gray
module_eigengenes <- ModNetwork$MEs

#get number of genes for each module
table(ModNetwork$colors)

print(softPw)
dim(Nrepl_data)

```

```{r, eval=FALSE, purl=FALSE}
gene_modules <- ModNetwork$colors
blue_genes <- names(gene_modules)[gene_modules == "darkgreen"]
Nrepl_data<-as.data.frame(Nrepl_data)
blue_gene_expression <- as.data.frame(Nrepl_data[, colnames(Nrepl_data) %in% blue_genes])


tgene<-data.frame(blue_gene_expression[,1:7])

#Manual exploration to find genes
Sim_genes<-data.frame(G1=blue_gene_expression$Zm00001eb085150, G2=blue_gene_expression$Zm00001eb085160, G3=blue_gene_expression$Zm00001eb104140, G4=blue_gene_expression$Zm00001eb104170)

#png(paste0("./CorPlots/2gene_",specie, ".png"), width=1600, height=800)
par(mar=c(8, 4, 4, 2))
plot(Sim_genes$G4, type="l", col="darkblue", xlab="", ylab="Gene Expression", main=paste0("Co-expression comparison in ", specie), lwd=2, xaxt="n")
lines(Sim_genes$G3, col="darkred", lwd=2)
lines(Sim_genes$G1, col="darkgreen", lty=2, lwd=2)
lines(Sim_genes$G2, col="purple", lty=2, lwd=2)
legend(x="bottomright", legend=c("Zm00001eb104170", "Zm00001eb104140", "Zm00001eb085150", "Zm00001eb085160"), lty=c(1,1,2,2), col=c("darkblue", "darkred", "darkgreen", "purple"), y.intersp=1, cex=1.3, lwd=c(2,2,2,2))
axis(1, at=1:nrow(blue_gene_expression), labels=FALSE)  #No label ticks
text(x=1:nrow(blue_gene_expression), y=par("usr")[3] - 0.2,  #45 degree ticks
     labels=rownames(blue_gene_expression), srt=45, adj=1, xpd=TRUE, cex=0.85)
mtext("Replicates", side=1, line=6) #Name doesent fit
#dev.off()

library(reshape2)  # For data transformation

blue_gene_expression<-tgene
# Convert data to long format for ggplot
blue_gene_expression$sample<-rownames(blue_gene_expression)
blue_gene_expression_long <- melt(blue_gene_expression)
colnames(blue_gene_expression_long) <- c("Sample", "Gene", "Expression")

# Create the line plot
ggGene<-ggplot(blue_gene_expression_long, aes(x = Sample, y = Expression, group = Gene, color = Gene)) +
  geom_line(alpha = 0.7) +  # Plot lines for each gene
  theme_minimal() +
  labs(title = "Gene Expression in Smallest Module",
       x = "Replicate",
       y = "Expression Level",
       color = "Gene") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

show(ggGene)
#ggsave(filename="./ModuleExp.png" ,ggGene)

```



```{r EigenColorsPlot}
#Plot the dendrogram and the module colors before and after merging underneath
plotDendroAndColors(ModNetwork$dendrograms[[1]], cbind(ModNetwork$unmergedColors, ModNetwork$colors),
                    c("unmerged", "merged"),
                    dendroLabels = FALSE,
                    addGuide = TRUE,
                    hang= 0.03,
                    guideHang = 0.05)
#https://www.nature.com/articles/s41588-024-02069-y
```

## Relate modules to traits

### Binarize metadata

Binarize the location

```{r binMeta}
levels(as.factor(repl_meta$location))

bin_metadata <- data.frame(
  cob_b73=as.integer(repl_meta$location=="b73_cob"),
  coleoptile_b73=as.integer(repl_meta$location=="b73_coleoptile"),
  crown_root_b73=as.integer(repl_meta$location=="b73_crown.root"),
  first_elongated_internode_b73=as.integer(repl_meta$location=="b73_first.elongated.internode"),
  flag_leaf_b73=as.integer(repl_meta$location=="b73_flag.leaf"),
  immature_cob_b73=as.integer(repl_meta$location=="b73_immature.cob"),
  immature_tassel_b73=as.integer(repl_meta$location=="b73_immature.tassel"),
  leaf_1_b73=as.integer(repl_meta$location=="b73_leaf.1"),
  leaf_3_blade_b73=as.integer(repl_meta$location=="b73_leaf.3.blade"),
  leaf_3_sheath_b73=as.integer(repl_meta$location=="b73_leaf.3.sheath"),
  leaf_5_b73=as.integer(repl_meta$location=="b73_leaf.5"),
  leaf_5_elongation_zone_b73=as.integer(repl_meta$location=="b73_leaf.5.elongation.zone"),
  leaf_5_mature_b73=as.integer(repl_meta$location=="b73_leaf.5.mature"),
  leaf_5_meristem_b73=as.integer(repl_meta$location=="b73_leaf.5.meristem"),
  leaf_8_b73=as.integer(repl_meta$location=="b73_leaf.8"),
  mature_seed_40_dap_b73=as.integer(repl_meta$location=="b73_mature.seed.40.dap"),
  meotic_tassel_b73=as.integer(repl_meta$location=="b73_meotic.tassel"),
  mesophyll_b73=as.integer(repl_meta$location=="b73_mesophyll"),
  prepollinated_cob_b73=as.integer(repl_meta$location=="b73_prepollinated.cob"),
  primary_root_b73=as.integer(repl_meta$location=="b73_primary.root"),
  primary_root_elongation_zone_b73=as.integer(repl_meta$location=="b73_primary.root.elongation.zone"),
  primary_root_meristematic_zone_b73=as.integer(repl_meta$location=="b73_primary.root.meristematic.zone"),
  root_hair_zone_b73=as.integer(repl_meta$location=="b73_root.hair.zone"),
  seed_10_dap_b73=as.integer(repl_meta$location=="b73_seed.10.dap"),
  seed_15_dap_b73=as.integer(repl_meta$location=="b73_seed.15.dap"),
  seed_20_dap_b73=as.integer(repl_meta$location=="b73_seed.20.dap"),
  seed_25_dap_b73=as.integer(repl_meta$location=="b73_seed.25.dap"),
  seed_30_dap_b73=as.integer(repl_meta$location=="b73_seed.30.dap"),
  seminal_root_b73=as.integer(repl_meta$location=="b73_seminal.root"),
  silk_b73=as.integer(repl_meta$location=="b73_silk"),
  
  cob_dk105=as.integer(repl_meta$location=="dk105_cob"),
  coleoptile_dk105=as.integer(repl_meta$location=="dk105_coleoptile"),
  crown_root_dk105=as.integer(repl_meta$location=="dk105_crown.root"),
  first_elongated_internode_dk105=as.integer(repl_meta$location=="dk105_first.elongated.internode"),
  flag_leaf_dk105=as.integer(repl_meta$location=="dk105_flag.leaf"),
  immature_cob_dk105=as.integer(repl_meta$location=="dk105_immature.cob"),
  immature_tassel_dk105=as.integer(repl_meta$location=="dk105_immature.tassel"),
  leaf_1_dk105=as.integer(repl_meta$location=="dk105_leaf.1"),
  leaf_3_blade_dk105=as.integer(repl_meta$location=="dk105_leaf.3.blade"),
  leaf_3_sheath_dk105=as.integer(repl_meta$location=="dk105_leaf.3.sheath"),
  leaf_5_dk105=as.integer(repl_meta$location=="dk105_leaf.5"),
  leaf_5_elongation_zone_dk105=as.integer(repl_meta$location=="dk105_leaf.5.elongation.zone"),
  leaf_5_mature_dk105=as.integer(repl_meta$location=="dk105_leaf.5.mature"),
  leaf_5_meristem_dk105=as.integer(repl_meta$location=="dk105_leaf.5.meristem"),
  leaf_8_dk105=as.integer(repl_meta$location=="dk105_leaf.8"),
  mature_seed_40_dap_dk105=as.integer(repl_meta$location=="dk105_mature.seed.40.dap"),
  meotic_tassel_dk105=as.integer(repl_meta$location=="dk105_meotic.tassel"),
  mesophyll_dk105=as.integer(repl_meta$location=="dk105_mesophyll"),
  prepollinated_cob_dk105=as.integer(repl_meta$location=="dk105_prepollinated.cob"),
  primary_root_dk105=as.integer(repl_meta$location=="dk105_primary.root"),
  primary_root_elongation_zone_dk105=as.integer(repl_meta$location=="dk105_primary.root.elongation.zone"),
  primary_root_meristematic_zone_dk105=as.integer(repl_meta$location=="dk105_primary.root.meristematic.zone"),
  root_hair_zone_dk105=as.integer(repl_meta$location=="dk105_root.hair.zone"),
  seed_10_dap_dk105=as.integer(repl_meta$location=="dk105_seed.10.dap"),
  seed_15_dap_dk105=as.integer(repl_meta$location=="dk105_seed.15.dap"),
  seed_20_dap_dk105=as.integer(repl_meta$location=="dk105_seed.20.dap"),
  seed_25_dap_dk105=as.integer(repl_meta$location=="dk105_seed.25.dap"),
  seed_30_dap_dk105=as.integer(repl_meta$location=="dk105_seed.30.dap"),
  seminal_root_dk105=as.integer(repl_meta$location=="dk105_seminal.root"),
  silk_dk105=as.integer(repl_meta$location=="dk105_silk"),
  
  cob_ep1=as.integer(repl_meta$location=="ep1_cob"),
  coleoptile_ep1=as.integer(repl_meta$location=="ep1_coleoptile"),
  crown_root_ep1=as.integer(repl_meta$location=="ep1_crown.root"),
  first_elongated_internode_ep1=as.integer(repl_meta$location=="ep1_first.elongated.internode"),
  flag_leaf_ep1=as.integer(repl_meta$location=="ep1_flag.leaf"),
  immature_cob_ep1=as.integer(repl_meta$location=="ep1_immature.cob"),
  immature_tassel_ep1=as.integer(repl_meta$location=="ep1_immature.tassel"),
  leaf_1_ep1=as.integer(repl_meta$location=="ep1_leaf.1"),
  leaf_3_blade_ep1=as.integer(repl_meta$location=="ep1_leaf.3.blade"),
  leaf_3_sheath_ep1=as.integer(repl_meta$location=="ep1_leaf.3.sheath"),
  leaf_5_ep1=as.integer(repl_meta$location=="ep1_leaf.5"),
  leaf_5_elongation_zone_ep1=as.integer(repl_meta$location=="ep1_leaf.5.elongation.zone"),
  leaf_5_mature_ep1=as.integer(repl_meta$location=="ep1_leaf.5.mature"),
  leaf_5_meristem_ep1=as.integer(repl_meta$location=="ep1_leaf.5.meristem"),
  leaf_8_ep1=as.integer(repl_meta$location=="ep1_leaf.8"),
  mature_seed_40_dap_ep1=as.integer(repl_meta$location=="ep1_mature.seed.40.dap"),
  meotic_tassel_ep1=as.integer(repl_meta$location=="ep1_meotic.tassel"),
  mesophyll_ep1=as.integer(repl_meta$location=="ep1_mesophyll"),
  prepollinated_cob_ep1=as.integer(repl_meta$location=="ep1_prepollinated.cob"),
  primary_root_ep1=as.integer(repl_meta$location=="ep1_primary.root"),
  primary_root_elongation_zone_ep1=as.integer(repl_meta$location=="ep1_primary.root.elongation.zone"),
  primary_root_meristematic_zone_ep1=as.integer(repl_meta$location=="ep1_primary.root.meristematic.zone"),
  root_hair_zone_ep1=as.integer(repl_meta$location=="ep1_root.hair.zone"),
  seed_10_dap_ep1=as.integer(repl_meta$location=="ep1_seed.10.dap"),
  seed_15_dap_ep1=as.integer(repl_meta$location=="ep1_seed.15.dap"),
  seed_20_dap_ep1=as.integer(repl_meta$location=="ep1_seed.20.dap"),
  seed_25_dap_ep1=as.integer(repl_meta$location=="ep1_seed.25.dap"),
  seed_30_dap_ep1=as.integer(repl_meta$location=="ep1_seed.30.dap"),
  seminal_root_ep1=as.integer(repl_meta$location=="ep1_seminal.root"),
  silk_ep1=as.integer(repl_meta$location=="ep1_silk"),
  
  cob_f7=as.integer(repl_meta$location=="f7_cob"),
  coleoptile_f7=as.integer(repl_meta$location=="f7_coleoptile"),
  crown_root_f7=as.integer(repl_meta$location=="f7_crown.root"),
  first_elongated_internode_f7=as.integer(repl_meta$location=="f7_first.elongated.internode"),
  flag_leaf_f7=as.integer(repl_meta$location=="f7_flag.leaf"),
  immature_cob_f7=as.integer(repl_meta$location=="f7_immature.cob"),
  immature_tassel_f7=as.integer(repl_meta$location=="f7_immature.tassel"),
  leaf_1_f7=as.integer(repl_meta$location=="f7_leaf.1"),
  leaf_3_blade_f7=as.integer(repl_meta$location=="f7_leaf.3.blade"),
  leaf_3_sheath_f7=as.integer(repl_meta$location=="f7_leaf.3.sheath"),
  leaf_5_f7=as.integer(repl_meta$location=="f7_leaf.5"),
  leaf_5_elongation_zone_f7=as.integer(repl_meta$location=="f7_leaf.5.elongation.zone"),
  leaf_5_mature_f7=as.integer(repl_meta$location=="f7_leaf.5.mature"),
  leaf_5_meristem_f7=as.integer(repl_meta$location=="f7_leaf.5.meristem"),
  leaf_8_f7=as.integer(repl_meta$location=="f7_leaf.8"),
  mature_seed_40_dap_f7=as.integer(repl_meta$location=="f7_mature.seed.40.dap"),
  meotic_tassel_f7=as.integer(repl_meta$location=="f7_meotic.tassel"),
  mesophyll_f7=as.integer(repl_meta$location=="f7_mesophyll"),
  prepollinated_cob_f7=as.integer(repl_meta$location=="f7_prepollinated.cob"),
  primary_root_f7=as.integer(repl_meta$location=="f7_primary.root"),
  primary_root_elongation_zone_f7=as.integer(repl_meta$location=="f7_primary.root.elongation.zone"),
  primary_root_meristematic_zone_f7=as.integer(repl_meta$location=="f7_primary.root.meristematic.zone"),
  root_hair_zone_f7=as.integer(repl_meta$location=="f7_root.hair.zone"),
  seed_10_dap_f7=as.integer(repl_meta$location=="f7_seed.10.dap"),
  seed_15_dap_f7=as.integer(repl_meta$location=="f7_seed.15.dap"),
  seed_20_dap_f7=as.integer(repl_meta$location=="f7_seed.20.dap"),
  seed_25_dap_f7=as.integer(repl_meta$location=="f7_seed.25.dap"),
  seed_30_dap_f7=as.integer(repl_meta$location=="f7_seed.30.dap"),
  seminal_root_f7=as.integer(repl_meta$location=="f7_seminal.root"),
  silk_f7=as.integer(repl_meta$location=="f7_silk"),
  
  cob_pe75=as.integer(repl_meta$location=="pe75_cob"),
  coleoptile_pe75=as.integer(repl_meta$location=="pe75_coleoptile"),
  crown_root_pe75=as.integer(repl_meta$location=="pe75_crown.root"),
  first_elongated_internode_pe75=as.integer(repl_meta$location=="pe75_first.elongated.internode"),
  flag_leaf_pe75=as.integer(repl_meta$location=="pe75_flag.leaf"),
  immature_cob_pe75=as.integer(repl_meta$location=="pe75_immature.cob"),
  immature_tassel_pe75=as.integer(repl_meta$location=="pe75_immature.tassel"),
  leaf_1_pe75=as.integer(repl_meta$location=="pe75_leaf.1"),
  leaf_3_blade_pe75=as.integer(repl_meta$location=="pe75_leaf.3.blade"),
  leaf_3_sheath_pe75=as.integer(repl_meta$location=="pe75_leaf.3.sheath"),
  leaf_5_pe75=as.integer(repl_meta$location=="pe75_leaf.5"),
  leaf_5_elongation_zone_pe75=as.integer(repl_meta$location=="pe75_leaf.5.elongation.zone"),
  leaf_5_mature_pe75=as.integer(repl_meta$location=="pe75_leaf.5.mature"),
  leaf_5_meristem_pe75=as.integer(repl_meta$location=="pe75_leaf.5.meristem"),
  leaf_8_pe75=as.integer(repl_meta$location=="pe75_leaf.8"),
  mature_seed_40_dap_pe75=as.integer(repl_meta$location=="pe75_mature.seed.40.dap"),
  meotic_tassel_pe75=as.integer(repl_meta$location=="pe75_meotic.tassel"),
  mesophyll_pe75=as.integer(repl_meta$location=="pe75_mesophyll"),
  prepollinated_cob_pe75=as.integer(repl_meta$location=="pe75_prepollinated.cob"),
  primary_root_pe75=as.integer(repl_meta$location=="pe75_primary.root"),
  primary_root_elongation_zone_pe75=as.integer(repl_meta$location=="pe75_primary.root.elongation.zone"),
  primary_root_meristematic_zone_pe75=as.integer(repl_meta$location=="pe75_primary.root.meristematic.zone"),
  root_hair_zone_pe75=as.integer(repl_meta$location=="pe75_root.hair.zone"),
  seed_10_dap_pe75=as.integer(repl_meta$location=="pe75_seed.10.dap"),
  seed_15_dap_pe75=as.integer(repl_meta$location=="pe75_seed.15.dap"),
  seed_20_dap_pe75=as.integer(repl_meta$location=="pe75_seed.20.dap"),
  seed_25_dap_pe75=as.integer(repl_meta$location=="pe75_seed.25.dap"),
  seed_30_dap_pe75=as.integer(repl_meta$location=="pe75_seed.30.dap"),
  seminal_root_pe75=as.integer(repl_meta$location=="pe75_seminal.root"),
  silk_pe75=as.integer(repl_meta$location=="pe75_silk")
)

rownames(bin_metadata)<-rownames(Nrepl_data)

bin_metadata<-bin_metadata[,colSums(bin_metadata)>=1]#if any rtissue is not present in sample, it will be introduced in binarization, as a full 0 column, remove it again
```

```{r binSort}
bin_metadata <- bin_metadata[, sort(names(bin_metadata))]
bin_metadata <- bin_metadata[order(rownames(bin_metadata)), ]
```


### Correlation

```{r corCalc}
nTissues <- nrow(Nrepl_data)
nGenes <- ncol(Nrepl_data)

MT_cor<-cor(module_eigengenes, bin_metadata, use="p")
module.trait.corr.pvals <- corPvalueStudent(MT_cor, nTissues)

```

# Coexpression visualization

```{r visCoexp}
heatmap.data <- merge(module_eigengenes, bin_metadata, by = 'row.names')

head(heatmap.data)

rownames(heatmap.data)<-heatmap.data$Row.names
heatmap.data$Row.names<-NULL

head(heatmap.data)

plotTitle<-paste0("Correlation plot of ", specie, " using ", NormType)
#png(paste0("./CorPlots/", specie, "_", NormType, "_corplot.png"), width=1600, height=800) #B73_CPM_corplot
CorLevelPlot(heatmap.data,
             x = names(bin_metadata),
             y = names(module_eigengenes),
             titleX="Traits", titleY="Modules", main=plotTitle,
             rotLabX = 45, rotTitleY = 90,
             cexCorval = 0.7, cexLabY = 0.7, cexLabX = 0.7
            )
#dev.off()

```

```{r corTable, eval=FALSE, purl=FALSE}
textMatrix = paste(signif(MT_cor, 2), "\n(",
signif(module.trait.corr.pvals, 1), ")", sep = "");
dim(textMatrix) = dim(MT_cor)
par(mar = c(6, 8.5, 3, 3));

labeledHeatmap(Matrix = MT_cor,
xLabels = names(bin_metadata),
yLabels = names(module_eigengenes),
ySymbols = names(module_eigengenes),
colorLabels = FALSE,
colors = greenWhiteRed(50),
textMatrix = textMatrix,
setStdMargins = FALSE,
cex.text = 0.5,
zlim = c(-1,1),
main = paste("Module-trait relationships"))
```

